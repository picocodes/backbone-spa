!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],function(c,r,a){return e.Backbone=t(c,r,a)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=t(require("underscore"),require("backbone"),require("jquery")):e.Backbone=t(e._,e.Backbone,e.jQuery)}(this,function(e,t,c){function r(t,r){if(t&&e.isObject(t)){if(e.isFunction(t.getCacheKey))return t.getCacheKey(r);t=r&&r.url?r.url:e.isFunction(t.url)?t.url():t.url}else if(e.isFunction(t))return t(r);return r&&r.data?"string"==typeof r.data?t+"?"+r.data:t+"?"+c.param(r.data):t}function a(e,c,r){c=c||{};var a=t.fetchCache.getCacheKey(e,c),i=!1,n=c.lastSync||(new Date).getTime(),h=!1;a&&c.cache!==!1&&(c.cache||c.prefill)&&(c.expires!==!1&&(i=(new Date).getTime()+1e3*(c.expires||300)),c.prefillExpires!==!1&&(h=(new Date).getTime()+1e3*(c.prefillExpires||300)),t.fetchCache._cache[a]={expires:i,lastSync:n,prefillExpires:h,value:r},t.fetchCache.setLocalStorage())}function i(c,a){return e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=r(c,a)),t.fetchCache._cache[c]}function n(e,t){return i(e).lastSync}function h(c,a){e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=r(c,a)),delete t.fetchCache._cache[c],t.fetchCache.setLocalStorage()}function o(){t.fetchCache._cache={}}function s(){if(p&&t.fetchCache.localStorage)try{localStorage.setItem(t.fetchCache.getLocalStorageKey(),JSON.stringify(t.fetchCache._cache))}catch(e){var c=e.code||e.number||e.message;if(22!==c&&1014!==c)throw e;this._deleteCacheWithPriority()}}function l(){if(p&&t.fetchCache.localStorage){var e=localStorage.getItem(t.fetchCache.getLocalStorageKey())||"{}";t.fetchCache._cache=JSON.parse(e)}}function f(e){return window.setTimeout(e,0)}var u={modelFetch:t.Model.prototype.fetch,modelSync:t.Model.prototype.sync,collectionFetch:t.Collection.prototype.fetch},p=function(){var e="undefined"!=typeof window.localStorage;if(e)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(t){e=!1}return e}();return t.fetchCache=t.fetchCache||{},t.fetchCache._cache=t.fetchCache._cache||{},t.fetchCache.enabled=!0,t.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},t.fetchCache._prioritize=function(){var t=e.values(this._cache).sort(this.priorityFn),c=e.indexOf(e.values(this._cache),t[0]);return e.keys(this._cache)[c]},t.fetchCache._deleteCacheWithPriority=function(){t.fetchCache._cache[this._prioritize()]=null,delete t.fetchCache._cache[this._prioritize()],t.fetchCache.setLocalStorage()},t.fetchCache.getLocalStorageKey=function(){return"backboneCache"},"undefined"==typeof t.fetchCache.localStorage&&(t.fetchCache.localStorage=!0),t.Model.prototype.fetch=function(r){function a(){return r.prefill&&(!r.prefillExpires||l)}function n(){r.parse&&(p=d.parse(p,r)),d.set(p,r),e.isFunction(r.prefillSuccess)&&r.prefillSuccess.call(y,d,p,r),d.trigger("cachesync",d,p,r),d.trigger("sync",d,p,r),a()?C.notifyWith(y,[d]):(e.isFunction(r.success)&&r.success.call(y,d,p,r),C.resolveWith(y,[d]))}if(!t.fetchCache.enabled)return u.modelFetch.apply(this,arguments);r=e.defaults(r||{},{parse:!0});var h=t.fetchCache.getCacheKey(this,r),o=i(h),s=!1,l=!1,p=!1,C=new c.Deferred,y=r.context||this,d=this;if(o&&(s=o.expires,s=s&&o.expires<(new Date).getTime(),l=o.prefillExpires,l=l&&o.prefillExpires<(new Date).getTime(),p=o.value),!s&&(r.cache||r.prefill)&&p&&(null==r.async&&(r.async=!0),r.async?f(n):n(),!a()))return C.promise();var g=u.modelFetch.apply(this,arguments);return g.done(e.bind(C.resolve,y,this)).done(e.bind(t.fetchCache.setCache,null,this,r)).fail(e.bind(C.reject,y,this)),C.abort=g.abort,C.promise()},t.Model.prototype.sync=function(e,c,r){if("read"===e||!t.fetchCache.enabled)return u.modelSync.apply(this,arguments);var a,i,n=c.collection,o=[];for(o.push(t.fetchCache.getCacheKey(c,r)),n&&o.push(t.fetchCache.getCacheKey(n)),a=0,i=o.length;i>a;a++)h(o[a]);return u.modelSync.apply(this,arguments)},t.Collection.prototype.fetch=function(r){function a(){return r.prefill&&(!r.prefillExpires||l)}function n(){d[r.reset?"reset":"set"](p,r),e.isFunction(r.prefillSuccess)&&r.prefillSuccess.call(y,d),d.trigger("cachesync",d,p,r),d.trigger("sync",d,p,r),a()?C.notifyWith(y,[d]):(e.isFunction(r.success)&&r.success.call(y,d,p,r),C.resolveWith(y,[d]))}if(!t.fetchCache.enabled)return u.collectionFetch.apply(this,arguments);r=e.defaults(r||{},{parse:!0});var h=t.fetchCache.getCacheKey(this,r),o=i(h),s=!1,l=!1,p=!1,C=new c.Deferred,y=r.context||this,d=this;if(o&&(s=o.expires,s=s&&o.expires<(new Date).getTime(),l=o.prefillExpires,l=l&&o.prefillExpires<(new Date).getTime(),p=o.value),!s&&(r.cache||r.prefill)&&p&&(null==r.async&&(r.async=!0),r.async?f(n):n(),!a()))return C.promise();var g=u.collectionFetch.apply(this,arguments);return g.done(e.bind(C.resolve,y,this)).done(e.bind(t.fetchCache.setCache,null,this,r)).fail(e.bind(C.reject,y,this)),C.abort=g.abort,C.promise()},l(),t.fetchCache._superMethods=u,t.fetchCache.setCache=a,t.fetchCache.getCache=i,t.fetchCache.getCacheKey=r,t.fetchCache.getLastSync=n,t.fetchCache.clearItem=h,t.fetchCache.reset=o,t.fetchCache.setLocalStorage=s,t.fetchCache.getLocalStorage=l,t});
